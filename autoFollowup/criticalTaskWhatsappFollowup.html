<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Deadline Checker</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        font-size: 14px;
      }
      th {
        background-color: #f4f4f4;
      }
      .critical {
        background-color: #ffe5e5;
      }
      .whatsapp-link {
        text-decoration: none;
        color: white;
        background: #25d366;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h2>Critical Task Deadlines</h2>

    <table>
      <thead>
        <tr>
          <th>3</th>
          <th>Doc Code</th>
          <th>Task Details</th>
          <th>Task To</th>
          <th>Task To Contact</th>
          <th>Task By</th>
          <th>Task By Contact</th>
          <th>deadline</th>
          <th>Stage</th>
          <th>Action for Assignee</th>
          <th>Action for Assignor</th>
        </tr>
      </thead>
      <tbody id="taskTable"></tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script>
      async function loadTasks() {
        try {
          const res = await fetch("data.json"); // fetch from same folder
          const tasks = await res.json();
          console.log(tasks);

          const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
          const tbody = document.getElementById("taskTable");

          tasks.forEach((task, index) => {
            let currentStage = "";

            const row = document.createElement("tr");
            const isCritical =
              dayjs().isAfter(task.deadline, "day") ||
              dayjs().isSame(task.deadline, "day");
            if (isCritical) row.classList.add("critical");

            if (task.acceptanceStatus === "PENDING") {
              currentStage = "AWAIT ACCEPTANCE";
            } else if (
              task.acceptanceStatus === "ACCEPTED" &&
              !task.doneStatus
            ) {
              currentStage = "AWAIT COMPLETION";
            } else if (task.doneStatus && !task.acknowledgeStatus) {
              currentStage = "AWAIT ACKNOWLEDGEMENT";
            } else {
              currentStage = "????";
            }

            row.innerHTML = `
            <td>${index + 1}</td>
            <td>${task.docCode}</td>
            <td>${task.taskDetails}</td>
            <td>${task["Task To"]}</td>
            <td>${task["Task To Contact"]}</td>

            <td>${task["Task By"]}</td>
            <td>${task["Task By Contact"]}</td>
            <td>${dayjs(task.deadline).format("DD-MMM-YYYY")}</td>
            <td>${currentStage}</td>
            <td>
              ${
                isCritical
                  ? `<a class="whatsapp-link" target="_blank"
                       href="https://wa.me/91${String(
                         task["Task To Contact"]
                       ).replace(
                         /\D/g,
                         ""
                       )}?text=%F0%9F%94%94%20I.EVO%20Task%20Dashboard%20Update%20Notice%0A%0AHello%20${encodeURIComponent(
                      task["Task To"]
                    )}%2C%0A%0AThis%20is%20a%20quick%20update%20to%20inform%20you%20that%20a%20new%20update%20for%20our%20task%20management%20tool%20will%20be%20rolled%20out%20shortly.%0A%0AWe%20have%20completed%20housekeeping%20and%20archived%20all%20tasks%20created%20before%20June%2030th.%20However%2C%20our%20records%20show%20that%20some%20of%20your%20tasks%20remain%20%2Aoverdue%2A%20%28marked%20in%20red%29.%0A%0A%E2%9C%85%20Action%20Required%3A%0APlease%20review%20your%20personal%20dashboard%20ASAP%20and%20take%20necessary%20action%20on%20any%20outstanding%20critical%20tasks.%0A%0APlease%20note%3A%20SK%20will%20be%20personally%20monitoring%20the%20status%20of%20critical%20tasks.%20Your%20prompt%20attention%20will%20ensure%20a%20smooth%20process%20for%20everyone.%0A%0AThank%20you%20for%20your%20immediate%20cooperation.%0A%0ABest%20regards%2C">
                       WhatsApp
                     </a>`
                  : "-"
              }
            </td>
            <td>
              ${
                isCritical
                  ? `<a class="whatsapp-link" target="_blank"
                       href="https://wa.me/${
                         task["Task By Contact"]
                       }?text=%F0%9F%94%94%20I.EVO%20Task%20Dashboard%20Update%20Notice%0A%0AHello%20${encodeURIComponent(
                      task["Task To"]
                    )}%2C%0A%0AThis%20is%20a%20quick%20update%20to%20inform%20you%20that%20a%20new%20update%20for%20our%20task%20management%20tool%20will%20be%20rolled%20out%20shortly.%0A%0AWe%20have%20completed%20housekeeping%20and%20archived%20all%20tasks%20created%20before%20June%2030th.%20However%2C%20our%20records%20show%20that%20some%20of%20your%20tasks%20remain%20%2Aoverdue%2A%20%28marked%20in%20red%29.%0A%0A%E2%9C%85%20Action%20Required%3A%0APlease%20review%20your%20personal%20dashboard%20ASAP%20and%20take%20necessary%20action%20on%20any%20outstanding%20critical%20tasks.%0A%0APlease%20note%3A%20SK%20will%20be%20personally%20monitoring%20the%20status%20of%20critical%20tasks.%20Your%20prompt%20attention%20will%20ensure%20a%20smooth%20process%20for%20everyone.%0A%0AThank%20you%20for%20your%20immediate%20cooperation.%0A%0ABest%20regards%2C">
                       WhatsApp
                     </a>`
                  : "-"
              }
            </td>
          `;
            tbody.appendChild(row);
          });
        } catch (err) {
          console.error("Error loading tasks:", err);
        }
      }

      loadTasks();
    </script>
  </body>
</html>
