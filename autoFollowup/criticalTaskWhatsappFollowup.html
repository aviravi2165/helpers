<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Deadline Checker</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        font-size: 14px;
      }
      th {
        background-color: #f4f4f4;
      }
      .critical {
        background-color: #ffe5e5;
      }
      .today {
        background-color: #effdaf;
      }
      .whatsapp-link {
        text-decoration: none;
        color: white;
        background: #25d366;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
      }
      .whatsapp-link.clicked {
        background-color: red;
        color: white; /* optional */
      }
      tr:hover {
        background-color: #f0f0f0; /* slightly darker shade */
        cursor: pointer; /* optional */
      }
    </style>
  </head>
  <body>
    <h2>Critical Task Deadlines (Whatsapp Alers)</h2>
    <span id="criticalCount"></span>
    <table>
      <thead>
        <tr>
          <th>3</th>
          <th>Doc Code</th>
          <th>Task Details</th>
          <th>Task To</th>
          <th>Task To Contact</th>
          <th>Task By</th>
          <th>Task By Contact</th>
          <th>deadline</th>
          <th>Stage</th>
          <th>Action for Assignee</th>
          <th>Action for Assignor</th>
        </tr>
      </thead>
      <tbody id="taskTable"></tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script>
      async function loadTasks() {
        let criticalCount = 0;
        let todayCount = 0;
        let sno = 0;

        try {
          const res = await fetch("data.json"); // fetch from same folder
          const tasks = await res.json();

          const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
          const tbody = document.getElementById("taskTable");

          tasks.forEach((task, index) => {
            let currentStage = "";

            const row = document.createElement("tr");
            const isCritical = dayjs().isAfter(task.deadline, "day");
            const isToday = dayjs().isSame(task.deadline, "day");
            if (isCritical) {
              criticalCount++;
              row.classList.add("critical");
            }
            if (isToday) {
              todayCount++;
              row.classList.add("today");
            }
            if (task.acceptanceStatus === "PENDING") {
              currentStage = "AWAIT ACCEPTANCE";
            } else if (
              task.acceptanceStatus === "ACCEPTED" &&
              !task.doneStatus
            ) {
              currentStage = "AWAIT COMPLETION";
            } else if (task.doneStatus && !task.acknowledgeStatus) {
              currentStage = "AWAIT ACKNOWLEDGEMENT";
            } else {
              currentStage = "????";
            }

            const msg1 = `*${
              dayjs().isAfter(task.deadline, "day")
                ? "!!Critical Update"
                : "!!Alert"
            }*

Hello <recipient>,

You have a task in your dashboard with the following details:

*Task Code:* ${task.docCode}
*Details:* ${task.taskDetails}
*Deadline:* ${dayjs(task.deadline).format("DD-MMM-YYYY")}
*Current Stage:* ${currentStage}

Please take necessary action.

Thank you
Team Founder's Office`;
            if (isCritical || isToday)
              row.innerHTML = `
                  <td>${++sno}</td>
                  <td>${task.docCode}</td>
                  <td>${task.taskDetails}</td>
                  <td>${task["Task To"]}</td>
                  <td>${task["Task To Contact"]}</td>

                  <td>${task["Task By"]}</td>
                  <td>${task["Task By Contact"]}</td>
                  <td>${dayjs(task.deadline).format("DD-MMM-YYYY")}</td>
                  <td>${currentStage}</td>
                 <td>
                  ${
                    isCritical || isToday
                      ? `<a class="whatsapp-link" onclick="this.classList.add('clicked')"
                            target="_blank"
                            href="https://wa.me/91${String(
                              task["Task To Contact"]
                            ).replace(/\D/g, "")}?text=${encodeURIComponent(
                          msg1.replace("<recipient>", task["Task To"])
                        )}">
                            WhatsApp
                        </a>`
                      : "-"
                  }
                </td>

                 <td>
                  ${
                    isCritical || isToday
                      ? `<a class="whatsapp-link" onclick="this.classList.add('clicked')"
                            target="_blank"
                            href="https://wa.me/91${String(
                              task["Task By Contact"]
                            ).replace(/\D/g, "")}?text=${encodeURIComponent(
                          msg1.replace("<recipient>", task["Task By"])
                        )}">
                            WhatsApp
                        </a>`
                      : "-"
                  }
                </td>
                `;
            tbody.appendChild(row);
          });
        } catch (err) {
          console.error("Error loading tasks:", err);
        }
        document.getElementById(
          "criticalCount"
        ).innerHTML = `Over Due count : ${criticalCount} | Due Today : ${todayCount}`;
      }

      loadTasks();
    </script>
  </body>
</html>
